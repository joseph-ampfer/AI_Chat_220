<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Chatbot</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* Full-height layout */
      body {
        height: 100vh;
        overflow: hidden;
      }
      /* Sidebar chat history */
      .chat-history {
        height: calc(100vh - 56px); /* Adjust based on navbar height */
        overflow-y: auto;
        border-right: 1px solid #dee2e6;
      }
      /* Main chat area layout */
      .chat-area {
        height: calc(100vh - 56px);
        display: flex;
        flex-direction: column;
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
      }
      .chat-input {
        padding: 10px;
        border-top: 1px solid #dee2e6;
      }
      .list-group-item[data-index] {
        cursor: pointer;
      }
      .list-group-item[data-index]:hover {
        background-color: rgb(186, 186, 186);
      }
      .list-group-item[data-index]:active {
        background-color: rgb(186, 186, 186);
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">AI Chatbot</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarContent"
          aria-controls="navbarContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
          <!-- Additional nav items can be added here -->
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <button id="modelSelect-btn" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                gemma2-9b-it
              </button>
              <ul id="modelSelect" class="dropdown-menu ">
                <li><a class="dropdown-item" >gemma2-9b-it</a></li>
                <li><a class="dropdown-item" >llama-3.3-70b-versatile</a></li>
                <li><a class="dropdown-item" >deepseek-r1-distill-qwen-32b</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content Area -->
    <div class="container-fluid">
      <div class="row">
        <!-- Aside: Chat History -->
        <aside class="col-md-3 chat-history bg-light">
          <div class="p-3">
            <button id="newChat" class="btn btn-primary mb-3">New Chat</button>
            <h5>Chat History</h5>
            <ul id="chatHistory" class="list-group">
              <li class="list-group-item">Conversation 1</li>
              <li class="list-group-item">Conversation 2</li>
              <li class="list-group-item">Conversation 3</li>
              <!-- More conversation items -->
            </ul>
          </div>
        </aside>

        <!-- Main Chat Interface -->
        <main class="col-md-9 chat-area">
          <div class="chat-messages" id="chatMessages">
            <!-- Chat messages will appear here -->
            <div class="mb-3">
              <div class="alert alert-secondary" role="alert">
                Hello! How can I assist you today?
              </div>
            </div>
          </div>
          <div class="chat-input">
            <form id="chatForm" class="d-flex">
              <input
                type="text"
                class="form-control me-2"
                id="userMessage"
                placeholder="Type your message..."
                autocomplete="off"
              />
              <button class="btn btn-primary" type="submit">Send</button>
            </form>
          </div>
        </main>
      </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AXios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Include Marked.js to process markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
    <!-- API Keys -->
    <script src="./config/keys.js"></script>
    <script>

      // Constants
      const JSON_BLOB_URL = 'https://jsonblob.com/api/jsonBlob/1344685504943284224';
      const groqEndpoint = "https://api.groq.com/openai/v1/chat/completions";
      const chatMessages = document.getElementById('chatMessages');
      const chatForm = document.getElementById('chatForm');
      const messageInput = document.getElementById('userMessage');
      const modelDropdown = document.querySelector('#modelSelect');
      const modelBtn = document.querySelector('#modelSelect-btn');

      // Global Variables
      let conversation = [];
      let blobData = {};
      let currentChatIndex = 0;
      let model = modelBtn.innerText;

      document.querySelectorAll('#modelSelect li a').forEach(e => {
        e.addEventListener('click', function() {
          modelBtn.innerText = e.innerText;
          model = e.innerText;
        })
      });

      document.getElementById('newChat').addEventListener('click', function() {
        blobData.chats.push({});
        chatMessages.innerHTML = '';
        currentChatIndex = blobData.chats.length-1;
      })



      // Helper: Fetch JSON from URL
      async function fetchJSON(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Fetch failed: ${response.statusText}`);
        return response.json();
      }


      // Helper: Update JSON Blob
      async function updateJSONBlob(data) {
        const response = await fetch(JSON_BLOB_URL, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(data)
        });
        if (!response.ok) {
          throw new Error(`Update JSON Blob failed: ${response.statusText}`);
        }
      }

      

      // Helper: Display message in chat
      function appendMessage(message, isUser = true) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('mb-3');
        if (isUser) {
          messageDiv.classList.add('text-end');
          messageDiv.innerHTML = `<span class="badge bg-primary">${message}</span>`;
        } else {
          messageDiv.innerHTML = marked.parse(message);
        }
        chatMessages.appendChild(messageDiv);
      }

      // Load chats for side bar
      async function loadSideBar() {

        blobData.chats.forEach((chat, index) => {
          let title = chat.title;
          let li = document.createElement('li');
          li.classList.add('list-group-item');
          li.innerText = title;
          li.dataset.index = index;
          li.addEventListener('click', () => loadChatByIndex(index));
          document.querySelector('#chatHistory').appendChild(li);
        }); 

      }

      function loadChatByIndex(index) {
        chatMessages.innerHTML = '';
        const selectedChat = blobData.chats[index];
        if (selectedChat && selectedChat.conversation) {
          conversation = selectedChat.conversation;

           // Display chat history with append message
          for (let i = 0; i < conversation.length; i++) {
            appendMessage(conversation[i].content, i % 2 === 0)
          }
          currentChatIndex = index;
          console.log('Current chat index:', currentChatIndex);
          console.log(conversation);
        }
      }

      // Load conversation history from jsonBlob
      async function loadChat() {
        try {
          blobData = await fetchJSON(JSON_BLOB_URL);
          // Ensure blobData.chats exists; if not, you might initialize it
          if (!blobData.chats) {
            blobData.chats = [];
          }

          // Load chat history (titles) into the aside
          loadSideBar();

          // Optionally load the first chat automatically:
          if (blobData.chats.length > 0) {
            loadChatByIndex(0);
          }
        } catch (error) {
          console.error("Failed to load chat:", error);
        }
      }


      // Send user message and get bot response
      async function sendMessageToAI(message) {
        try {
          appendMessage(message); // Display user message
          conversation.push({ role: 'user', content: message });

          // Fetch ai response
          const response = await fetch(groqEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${GROQ_API_KEY}`
            },
            body: JSON.stringify({ messages: conversation, model: model}),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error ${response.status}: ${errorText}`);
          }

          const resJson = await response.json();
          const botMessage = resJson.choices?.[0]?.message?.content ?? "No response.";
          appendMessage(botMessage, false); // Display bot response
          conversation.push({ role: "assistant", content: botMessage });

          // Update the blob data with the new conversation
          blobData.chats[currentChatIndex].conversation = conversation;

          // Update conversation in JSON blob
          await updateJSONBlob(blobData);
        } catch (error) {
          console.error("Request failed:", error);
          appendMessage("ðŸš« Oops! Something went wrong. Please try again.", false);
        } finally {
          chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
        }
      }


      // Handle form submission
      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
          sendMessageToAI(message);
          messageInput.value = ""; // Clear input
        }
      });

      // Load the chat on page load
      loadChat();
      loadSideBar();
 
     
    </script>
  </body>
</html>

  <!-- // // Axios request
  // try {
  //   // Send post request to Groq using Axios
  //   const { data } = await axios.post(
  //     endpoint,
  //     {
  //       messages: conversation,
  //       model: 'gemma2-9b-it'
  //     },
  //     {
  //       headers: {
  //         "Content-Type": "application/json",
  //         Authorization: `Bearer ${GROQ_API_KEY}`
  //       }
  //     }
  //   );

  //   // Get chat message content
  //   let botResponse = data.choices[0].message?.content;
  //   //botResponse = marked.parse(botResponse);

  //   // Create and append the message div
  //   const aiMessageDiv = document.createElement("div");
  //   aiMessageDiv.classList.add("mb-3");
  //   aiMessageDiv.innerHTML = botResponse;
  //   chatMessages.appendChild(aiMessageDiv);

  //   // Scroll to bottom and add to history
  //   chatMessages.scrollTop = chatMessages.scrollHeight;
  //   conversation.push({ role: "assistant", content: botResponse });
  // } catch (error) {
  //   console.error("API request failed:", error);

  //   // Optional: Show error message in the UI
  //   const errorDiv = document.createElement("div");
  //   errorDiv.classList.add("mb-3", "text-red-500");
  //   errorDiv.textContent = "Oops! Something went wrong. Please try again.";
  //   chatMessages.appendChild(errorDiv);
  // } -->
